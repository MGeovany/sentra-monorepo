name: Bump Homebrew formula

on:
  workflow_run:
    workflows: ["Release CLI"]
    types: [completed]

permissions:
  contents: read

jobs:
  bump:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v') }}
    steps:
      - name: Compute checksums
        id: sums
        env:
          TAG: ${{ github.event.workflow_run.head_branch }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG}" ]]; then
            echo "missing release tag"
            exit 1
          fi

          ver="${TAG#v}"
          echo "version=${ver}" >> "$GITHUB_OUTPUT"

          base="https://github.com/MGeovany/sentra-cli/releases/download/${TAG}"

          curl -fsSL "${base}/sentra_darwin_arm64" -o sentra_darwin_arm64
          curl -fsSL "${base}/sentra_darwin_amd64" -o sentra_darwin_amd64
          curl -fsSL "${base}/sentra_linux_arm64"  -o sentra_linux_arm64
          curl -fsSL "${base}/sentra_linux_amd64"  -o sentra_linux_amd64

          sha_darwin_arm64=$(sha256sum sentra_darwin_arm64 | awk '{print $1}')
          sha_darwin_amd64=$(sha256sum sentra_darwin_amd64 | awk '{print $1}')
          sha_linux_arm64=$(sha256sum sentra_linux_arm64 | awk '{print $1}')
          sha_linux_amd64=$(sha256sum sentra_linux_amd64 | awk '{print $1}')

          echo "sha_darwin_arm64=${sha_darwin_arm64}" >> "$GITHUB_OUTPUT"
          echo "sha_darwin_amd64=${sha_darwin_amd64}" >> "$GITHUB_OUTPUT"
          echo "sha_linux_arm64=${sha_linux_arm64}" >> "$GITHUB_OUTPUT"
          echo "sha_linux_amd64=${sha_linux_amd64}" >> "$GITHUB_OUTPUT"

      - name: Update tap repo
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
          VERSION: ${{ steps.sums.outputs.version }}
          SHA_DARWIN_ARM64: ${{ steps.sums.outputs.sha_darwin_arm64 }}
          SHA_DARWIN_AMD64: ${{ steps.sums.outputs.sha_darwin_amd64 }}
          SHA_LINUX_ARM64: ${{ steps.sums.outputs.sha_linux_arm64 }}
          SHA_LINUX_AMD64: ${{ steps.sums.outputs.sha_linux_amd64 }}
        run: |
          set -euo pipefail

          if [[ -z "${TAP_TOKEN}" ]]; then
            echo "missing secret HOMEBREW_TAP_TOKEN"
            echo "create a PAT with access to MGeovany/homebrew-tap and add it as a repo secret"
            exit 1
          fi

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/MGeovany/homebrew-tap.git" tap
          cd tap
          mkdir -p Formula

          cat > Formula/sentra.rb <<'          SENTRA_FORMULA'
          class Sentra < Formula
            desc "Sentra CLI"
            homepage "https://github.com/MGeovany/sentra-cli"
            version "__VERSION__"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/MGeovany/sentra-cli/releases/download/__TAG__/sentra_darwin_arm64"
                sha256 "__SHA_DARWIN_ARM64__"
              else
                url "https://github.com/MGeovany/sentra-cli/releases/download/__TAG__/sentra_darwin_amd64"
                sha256 "__SHA_DARWIN_AMD64__"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/MGeovany/sentra-cli/releases/download/__TAG__/sentra_linux_arm64"
                sha256 "__SHA_LINUX_ARM64__"
              else
                url "https://github.com/MGeovany/sentra-cli/releases/download/__TAG__/sentra_linux_amd64"
                sha256 "__SHA_LINUX_AMD64__"
              end
            end

            def install
              bin.install Dir["sentra_*"][0] => "sentra"
            end

            test do
              system "#{bin}/sentra", "--help"
            end
          end
          SENTRA_FORMULA

          perl -pi -e "s/__VERSION__/${VERSION}/g" Formula/sentra.rb
          perl -pi -e "s/__TAG__/${TAG}/g" Formula/sentra.rb
          perl -pi -e "s/__SHA_DARWIN_ARM64__/${SHA_DARWIN_ARM64}/g" Formula/sentra.rb
          perl -pi -e "s/__SHA_DARWIN_AMD64__/${SHA_DARWIN_AMD64}/g" Formula/sentra.rb
          perl -pi -e "s/__SHA_LINUX_ARM64__/${SHA_LINUX_ARM64}/g" Formula/sentra.rb
          perl -pi -e "s/__SHA_LINUX_AMD64__/${SHA_LINUX_AMD64}/g" Formula/sentra.rb

          git add Formula/sentra.rb
          if git diff --cached --quiet; then
            echo "no changes to commit"
            exit 0
          fi

          git config user.name "sentra-bot"
          git config user.email "sentra-bot@users.noreply.github.com"
          git commit -m "sentra ${TAG}"
          git push origin main
